<app-navbar></app-navbar>

<div class="loan-application-container">
  <h2>Loan Application</h2>

  <!-- Prediction Result -->
  <div *ngIf="predictionResult" class="prediction-result" [ngClass]="predictionResult.riskLevel">
    <h3>Prediction Results</h3>
    <div class="result-card">
      <p><strong>Default Probability:</strong> {{ predictionResult.defaultProbability * 100 | number:'1.2-2' }}%</p>
      <p><strong>Risk Level:</strong> {{ predictionResult.riskLevel }}</p>
      <p><strong>Confidence:</strong> {{ predictionResult.confidence * 100 | number:'1.2-2' }}%</p>
      <p><strong>Model:</strong> {{ predictionResult.model }}</p>
    </div>
  </div>

  <!-- Success Message -->
  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="alert alert-error">
    {{ errorMessage }}
  </div>

  <!-- Loan Application Form -->
  <form [formGroup]="loanForm" (ngSubmit)="onSubmit()">

    <!-- Applicant Information Section -->
    <h3>Applicant Information</h3>

    <div class="form-row">
      <div class="form-group">
        <label for="name">Name *</label>
        <input type="text" id="name" formControlName="name" placeholder="John Doe">
        <div class="error" *ngIf="loanForm.get('name')?.invalid && loanForm.get('name')?.touched">
          Name is required
        </div>
      </div>

      <div class="form-group">
        <label for="email">Email *</label>
        <input type="email" id="email" formControlName="email" placeholder="john.doe@example.com">
        <div class="error" *ngIf="loanForm.get('email')?.invalid && loanForm.get('email')?.touched">
          Email is required and must be valid
        </div>
      </div>

      <div class="form-group">
        <label for="age">Age *</label>
        <input type="number" id="age" formControlName="age" placeholder="25">
        <div class="error" *ngIf="loanForm.get('age')?.invalid && loanForm.get('age')?.touched">
          Age is required (18-100)
        </div>
      </div>

      <div class="form-group">
        <label for="education">Education Level *</label>
        <select id="education" formControlName="education">
          <option value="">Select...</option>
          <option *ngFor="let level of educationOptions" [value]="level">
            {{ level }}
          </option>
        </select>
        <div class="error" *ngIf="loanForm.get('education')?.invalid && loanForm.get('education')?.touched">
          Education level is required
        </div>
      </div>

      <div class="form-group">
        <label for="maritalStatus">Marital Status *</label>
        <select id="maritalStatus" formControlName="maritalStatus">
          <option value="">Select...</option>
          <option *ngFor="let status of maritalStatusOptions" [value]="status">
            {{ status }}
          </option>
        </select>
        <div class="error" *ngIf="loanForm.get('maritalStatus')?.invalid && loanForm.get('maritalStatus')?.touched">
          Marital status is required
        </div>
      </div>

      <div class="form-group">
        <label for="hasDependents">Has Dependents? *</label>
        <select id="hasDependents" formControlName="hasDependents">
          <option value="">Select...</option>
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
        <div class="error" *ngIf="loanForm.get('hasDependents')?.invalid && loanForm.get('hasDependents')?.touched">
          This field is required
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="homeOwnership">Home Ownership *</label>
        <select id="homeOwnership" formControlName="homeOwnership">
          <option value="">Select...</option>
          <option *ngFor="let option of homeOwnershipOptions" [value]="option">
            {{ option }}
          </option>
        </select>
        <div class="error" *ngIf="loanForm.get('homeOwnership')?.invalid && loanForm.get('homeOwnership')?.touched">
          Home ownership is required
        </div>
      </div>

      <div class="form-group">
        <label for="hasMortgage">Has Mortgage? *</label>
        <select id="hasMortgage" formControlName="hasMortgage">
          <option value="">Select...</option>
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
        <div class="error" *ngIf="loanForm.get('hasMortgage')?.invalid && loanForm.get('hasMortgage')?.touched">
          This field is required
        </div>
      </div>
      <div class="form-group">
        <label for="employmentType">Employment Type *</label>
        <select id="employmentType" formControlName="employmentType">
          <option value="">Select...</option>
          <option *ngFor="let type of employmentTypeOptions" [value]="type">
            {{ type }}
          </option>
        </select>
        <div class="error" *ngIf="loanForm.get('employmentType')?.invalid && loanForm.get('employmentType')?.touched">
          Employment type is required
        </div>
      </div>

      <div class="form-group">
        <label for="employmentStatus">Employment Status *</label>
        <select id="employmentStatus" formControlName="employmentStatus">
          <option value="">Select...</option>
          <option *ngFor="let option of employmentStatusOptions" [value]="option">
            {{ option }}
          </option>
        </select>
        <div class="error"
          *ngIf="loanForm.get('employmentStatus')?.invalid && loanForm.get('employmentStatus')?.touched">
          Employment status is required
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="monthsEmployed">Months Employed *</label>
        <input type="number" id="monthsEmployed" formControlName="monthsEmployed" placeholder="24">
        <div class="error" *ngIf="loanForm.get('monthsEmployed')?.invalid && loanForm.get('monthsEmployed')?.touched">
          Months employed is required
        </div>
      </div>

      <div class="form-group">
        <label for="income">Income ($) *</label>
        <input type="number" id="income" formControlName="income" placeholder="50000">
        <div class="error" *ngIf="loanForm.get('income')?.invalid && loanForm.get('income')?.touched">
          Income is required (min $0)
        </div>
      </div>
    </div>

    <!-- Loan Details Section -->
    <h3>Loan Details</h3>

    <div class="form-row">
      <div class="form-group">
        <label for="loanAmount">Loan Amount ($) *</label>
        <input type="number" id="loanAmount" formControlName="loanAmount" placeholder="10000">
        <div class="error" *ngIf="loanForm.get('loanAmount')?.invalid && loanForm.get('loanAmount')?.touched">
          Loan amount is required (min $1000)
        </div>
      </div>

      <div class="form-group">
        <label for="loanPurpose">Loan Purpose *</label>
        <select id="loanPurpose" formControlName="loanPurpose">
          <option value="">Select...</option>
          <option *ngFor="let purpose of loanPurposeOptions" [value]="purpose">
            {{ purpose.replace('_', ' ') }}
          </option>
        </select>
        <div class="error" *ngIf="loanForm.get('loanPurpose')?.invalid && loanForm.get('loanPurpose')?.touched">
          Loan purpose is required
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="interestRate">Interest Rate (%) *</label>
        <input type="number" step="0.01" id="interestRate" formControlName="interestRate" placeholder="5.5">
        <div class="error" *ngIf="loanForm.get('interestRate')?.invalid && loanForm.get('interestRate')?.touched">
          Interest rate is required (0-30%)
        </div>
      </div>

      <div class="form-group">
        <label for="loanTerm">Loan Term (months) *</label>
        <input type="number" id="loanTerm" formControlName="loanTerm" placeholder="36">
        <div class="error" *ngIf="loanForm.get('loanTerm')?.invalid && loanForm.get('loanTerm')?.touched">
          Loan term is required (12-60 months)
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="hasCoSigner">Has Co-Signer? *</label>
        <select id="hasCoSigner" formControlName="hasCoSigner">
          <option value="">Select...</option>
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
        <div class="error" *ngIf="loanForm.get('hasCoSigner')?.invalid && loanForm.get('hasCoSigner')?.touched">
          This field is required
        </div>
      </div>
    </div>

    <!-- Credit Information Section -->
    <h3>Credit Information</h3>

    <div class="form-row">
      <div class="form-group">
        <label for="creditScore">Credit Score *</label>
        <input type="number" id="creditScore" formControlName="creditScore" placeholder="700">
        <div class="error" *ngIf="loanForm.get('creditScore')?.invalid && loanForm.get('creditScore')?.touched">
          Credit score is required (300-850)
        </div>
      </div>

      <div class="form-group">
        <label for="numCreditLines">Number of Credit Lines *</label>
        <input type="number" id="numCreditLines" formControlName="numCreditLines" placeholder="3">
        <div class="error" *ngIf="loanForm.get('numCreditLines')?.invalid && loanForm.get('numCreditLines')?.touched">
          Number of credit lines is required
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="button-group">
      <button type="submit" [disabled]="loading || loanForm.invalid" class="submit-btn">
        {{ loading ? 'Processing...' : 'Submit Application' }}
      </button>

      <button type="button" (click)="resetForm()" class="reset-btn" [disabled]="loading">
        Reset
      </button>
    </div>
  </form>

  <!-- Prediction Results Display - Stylish Version -->
<div class="results-wrapper" *ngIf="predictionResult && !loading">
  <div class="results-card">
    
    <!-- Header Section with Status -->
    <div class="status-header" [class.status-approved]="isApproved()" [class.status-denied]="isRejected()">
      <div class="status-icon-wrapper">
        <div class="icon-circle" [class.pulse-animation]="isApproved()">
          <!-- Checkmark for Approved -->
          <svg *ngIf="isApproved()" class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          <!-- X for Denied -->
          <svg *ngIf="isRejected()" class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
        </div>
      </div>
      
      <div class="status-content">
        <h1 class="status-title">
          {{ isApproved() ? 'Application Approved!' : 'Application Denied' }}
        </h1>
        <p class="status-subtitle">
          {{ isApproved() 
            ? 'Congratulations! Your loan application has been approved.' 
            : 'We\'re unable to approve your application at this time.' 
          }}
        </p>
      </div>
    </div>

    <!-- Success Message Alert -->
    <div class="success-alert" *ngIf="successMessage">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
      <span>{{ successMessage }}</span>
    </div>

    <!-- Key Metrics Cards -->
    <div class="metrics-container">
      <div class="metric-card metric-primary">
        <div class="metric-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        <div class="metric-content">
          <span class="metric-label">Decision</span>
          <span class="metric-value" [class.text-approved]="isApproved()" [class.text-denied]="isRejected()">
            {{ predictionResult.modelPrediction }}
          </span>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-icon" [style.background-color]="getRiskColor() + '20'">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" [attr.stroke]="getRiskColor()" stroke-width="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
          </svg>
        </div>
        <div class="metric-content">
          <span class="metric-label">Risk Level</span>
          <span class="metric-value">
            <span class="risk-badge-inline" [style.background-color]="getRiskColor()">
              {{ getRiskLevel() }}
            </span>
          </span>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
          </svg>
        </div>
        <div class="metric-content">
          <span class="metric-label">Confidence</span>
          <span class="metric-value">{{ (predictionResult.confidence * 100).toFixed(1) }}%</span>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        </div>
        <div class="metric-content">
          <span class="metric-label">Default Risk</span>
          <span class="metric-value">{{ (predictionResult.riskScore * 100).toFixed(2) }}%</span>
        </div>
      </div>
    </div>

    <!-- Risk Assessment Section -->
    <div class="risk-section">
      <div class="section-header">
        <h3 class="section-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
          </svg>
          Risk Assessment
        </h3>
        <span class="section-subtitle">Based on machine learning analysis</span>
      </div>

      <!-- Circular Progress Indicator -->
      <div class="risk-gauge">
        <div class="gauge-container">
          <svg class="gauge-svg" viewBox="0 0 200 120">
            <!-- Background Arc -->
            <path class="gauge-bg" d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="#e5e7eb" stroke-width="20" stroke-linecap="round"/>
            
            <!-- Colored Segments -->
            <path class="gauge-segment gauge-low" d="M 20 100 A 80 80 0 0 1 100 20" fill="none" stroke="#10b981" stroke-width="20" stroke-linecap="round" opacity="0.3"/>
            <path class="gauge-segment gauge-medium" d="M 100 20 A 80 80 0 0 1 180 100" fill="none" stroke="#f59e0b" stroke-width="20" stroke-linecap="round" opacity="0.3"/>
            
            <!-- Active Progress Arc -->
            <path class="gauge-progress" 
                  [attr.d]="getGaugeArc(predictionResult.riskScore)" 
                  fill="none" 
                  [attr.stroke]="getRiskColor()" 
                  stroke-width="20" 
                  stroke-linecap="round"/>
            
            <!-- Center Text -->
            <text x="100" y="85" text-anchor="middle" class="gauge-value">{{ (predictionResult.riskScore * 100).toFixed(1) }}%</text>
            <text x="100" y="105" text-anchor="middle" class="gauge-label">Risk Score</text>
          </svg>
          
          <div class="gauge-markers">
            <span class="marker marker-left">0%</span>
            <span class="marker marker-center">50%</span>
            <span class="marker marker-right">100%</span>
          </div>
        </div>
      </div>

      <!-- Horizontal Progress Bars -->
      <div class="probability-bars">
        <div class="probability-item">
          <div class="probability-header">
            <span class="probability-label">
              <span class="probability-dot" style="background: #ef4444;"></span>
              Default Probability
            </span>
            <span class="probability-percentage">{{ (predictionResult.modelPredictions.defaultRisk * 100).toFixed(2) }}%</span>
          </div>
          <div class="probability-bar-container">
            <div class="probability-bar-bg">
              <div class="probability-bar-fill" 
                   [style.width.%]="predictionResult.modelPredictions.defaultRisk * 100"
                   style="background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);"></div>
            </div>
          </div>
        </div>

        <div class="probability-item">
          <div class="probability-header">
            <span class="probability-label">
              <span class="probability-dot" style="background: #10b981;"></span>
              No Default Probability
            </span>
            <span class="probability-percentage">{{ (predictionResult.modelPredictions.average * 100).toFixed(2) }}%</span>
          </div>
          <div class="probability-bar-container">
            <div class="probability-bar-bg">
              <div class="probability-bar-fill" 
                   [style.width.%]="predictionResult.modelPredictions.average * 100"
                   style="background: linear-gradient(90deg, #10b981 0%, #059669 100%);"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="results-actions">
      <button type="button" class="btn-action btn-secondary" (click)="viewApplications()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        View History
      </button>
      <button type="button" class="btn-action btn-primary" (click)="resetForm()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="1 4 1 10 7 10"></polyline>
          <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
        </svg>
        New Application
      </button>
    </div>

  </div>
</div>
</div>

